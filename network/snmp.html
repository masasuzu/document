

<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>SNMP - Simple Network Management Protocol &mdash; masasuzu docs 1.0 documentation</title>
    
    <link rel="stylesheet" href="../_static/default.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../',
        VERSION:     '1.0',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <link rel="top" title="masasuzu docs 1.0 documentation" href="../index.html" />
    <link rel="up" title="ネットワークに関する雑多な記事" href="index.html" />
    <link rel="prev" title="ACL Access Control List" href="acl.html" /> 
  </head>
  <body>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="acl.html" title="ACL Access Control List"
             accesskey="P">previous</a> |</li>
        <li><a href="../index.html">masasuzu docs 1.0 documentation</a> &raquo;</li>
          <li><a href="index.html" accesskey="U">ネットワークに関する雑多な記事</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <div class="section" id="snmp-simple-network-management-protocol">
<h1>SNMP - Simple Network Management Protocol<a class="headerlink" href="#snmp-simple-network-management-protocol" title="Permalink to this headline">¶</a></h1>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Version:</th><td class="field-body">1.0 of 2011/04/06</td>
</tr>
<tr class="field-even field"><th class="field-name">Author:</th><td class="field-body">SUZUKI Masashi / masasuzu</td>
</tr>
<tr class="field-odd field"><th class="field-name">Mail:</th><td class="field-body"><a class="reference external" href="mailto:m15&#46;suzuki&#46;masashi&#37;&#52;&#48;gmail&#46;com">m15<span>&#46;</span>suzuki<span>&#46;</span>masashi<span>&#64;</span>gmail<span>&#46;</span>com</a></td>
</tr>
</tbody>
</table>
<div class="section" id="agenda">
<h2>Agenda<a class="headerlink" href="#agenda" title="Permalink to this headline">¶</a></h2>
<ol class="arabic simple">
<li>監視について</li>
<li>SNMPの概要</li>
<li>Net-SNMP</li>
<li>プログラムからSNMPにアクセスする</li>
</ol>
</div>
<div class="section" id="id1">
<h2>監視について<a class="headerlink" href="#id1" title="Permalink to this headline">¶</a></h2>
<p>監視には主に死活監視、障碍監視、性能監視、セキュリティ監視があります。</p>
<p>死活監視は、一定間隔でシステムに対してpingやTCPコネクションを張りTimeoutが無いことでサービスが死んでいないかを確認します。
障碍監視は、ログなどを確認しハードウェアエラーソフトウェアエラーがないかを監視します。
性能監視は、システムの性能(リソース)を継続的に監視し、グラフなどで傾向を可視化し、閾値を越えていないことを監視します。</p>
<ul class="simple">
<li>死活監視<ul>
<li>ping</li>
<li>traceroute</li>
<li>ssh</li>
<li>ポート監視</li>
<li>wget</li>
<li>Nagios</li>
<li>monit</li>
</ul>
</li>
<li>障碍監視<ul>
<li>snmp trap</li>
<li>syslog</li>
<li>ログ監視</li>
</ul>
</li>
<li>性能監視<ul>
<li>MRTG</li>
<li>Cacti</li>
<li>munin</li>
<li>CloudForcast</li>
</ul>
</li>
<li>セキュリティ監視<ul>
<li>IDS</li>
<li>Firewallログ監視</li>
</ul>
</li>
</ul>
</div>
<div class="section" id="snmp">
<h2>SNMPの概要<a class="headerlink" href="#snmp" title="Permalink to this headline">¶</a></h2>
<p>ネットワーク管理と各種モニタリングのための <strong>シンプルな</strong> プロトコル。</p>
<p>対象はルータやスイッチに限らず、Unixシステム、Windows、プリンタ、電源、WEBサーバ、DBサーバを監視できます。</p>
<div class="section" id="id2">
<h3>SNMPの機能<a class="headerlink" href="#id2" title="Permalink to this headline">¶</a></h3>
<p>SNMP主な機能には主に3つの機能があります。ここでは、管理対象機器を監視するノードを <em>管理機</em> 管理対象機器が持つ情報を <em>管理情報</em> とします。</p>
<ol class="arabic simple">
<li>管理対象機器が管理機に情報の <strong>通知</strong> する</li>
<li>管理機が管理対象機器に管理情報を <strong>要求</strong> する</li>
<li>管理機が管理対象機器に <strong>設定</strong> する</li>
</ol>
<p>っね、シンプルでしょ。</p>
</div>
<div class="section" id="id3">
<h3>SNMP管理フレームワーク<a class="headerlink" href="#id3" title="Permalink to this headline">¶</a></h3>
<p>SNMP管理フレームワークは4つの構成要素と4つの定義されています。</p>
<ul class="simple">
<li>4つの構成要素<ol class="arabic">
<li>管理対象機器</li>
<li>管理機</li>
<li>管理情報</li>
<li>SNMPプロトコル</li>
</ol>
</li>
<li>4つの定義<ol class="arabic">
<li>プロトコル定義</li>
<li>データ定義言語</li>
<li>管理情報定義</li>
<li>セキュリティと管理の定義</li>
</ol>
</li>
</ul>
<img alt="../_images/snmp_overview.png" src="../_images/snmp_overview.png" />
<p>っね、シンプルでしょ。。</p>
</div>
<div class="section" id="id4">
<h3>SNMP管理フレームワークのバージョン<a class="headerlink" href="#id4" title="Permalink to this headline">¶</a></h3>
<p>4つの定義をそれぞれSNMP管理フレームワークのバージョンにマッピングすると以下の通りになります。下記の表は簡略化したものとなります。</p>
<table border="1" class="docutils">
<colgroup>
<col width="45%" />
<col width="18%" />
<col width="18%" />
<col width="18%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">&nbsp;</th>
<th class="head">v1</th>
<th class="head">v2</th>
<th class="head">v3</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td>プロトコル</td>
<td>SNMPv1</td>
<td>SNMPv2c</td>
<td>SNMPv3</td>
</tr>
<tr class="row-odd"><td>データ定義言語</td>
<td>SMIv1</td>
<td>SMIv2</td>
<td>SMIv2</td>
</tr>
<tr class="row-even"><td>管理情報</td>
<td>MIB-I</td>
<td>MIB-II</td>
<td>MIB-II</td>
</tr>
<tr class="row-odd"><td>セキュリティと管理の定義</td>
<td>Community</td>
<td>Community</td>
<td>USM/VACM</td>
</tr>
</tbody>
</table>
<dl class="docutils">
<dt>SMI</dt>
<dd>Structre of Management Information</dd>
<dt>MIB</dt>
<dd>Mabagement Informationn Base</dd>
<dt>USM</dt>
<dd>User-based Security Model</dd>
<dt>VACM</dt>
<dd>View-based Access Control Model</dd>
</dl>
</div>
</div>
<div class="section" id="smimib">
<h2>SMIとMIB<a class="headerlink" href="#smimib" title="Permalink to this headline">¶</a></h2>
<div class="section" id="smi-struscture-of-manangement-information">
<h3>SMI(Struscture of Manangement Information)<a class="headerlink" href="#smi-struscture-of-manangement-information" title="Permalink to this headline">¶</a></h3>
<p>SMIとは、ノードの管理オブジェクト(管理情報)の構造を定義するための定義です。</p>
<p>ANS.1と呼ばれる記述法を用います。</p>
<ul class="simple">
<li>構造: SMI</li>
<li>記述法: ASN.1</li>
</ul>
<p>SMIの構造は <em>名前と型</em> と <em>管理オブジェクト</em> から構成されます。名前はオブジェクトIDと呼ばれる一意の識別子で表現されます。SMIの型には以下のようなものがあります。</p>
<table border="1" class="docutils">
<colgroup>
<col width="47%" />
<col width="53%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">&nbsp;</th>
<th class="head">&nbsp;</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td rowspan="4">プリミティブ型
(単一の値)</td>
<td>整数(INTEGER)</td>
</tr>
<tr class="row-odd"><td>文字列(STRING)</td>
</tr>
<tr class="row-even"><td>カウンター(Counter)</td>
</tr>
<tr class="row-odd"><td>オブジェクトID(OID)</td>
</tr>
<tr class="row-even"><td rowspan="2">コンストラクタ型
(複数の値)</td>
<td>シーケンス(SEQUENCE)</td>
</tr>
<tr class="row-odd"><td>シーケンスオブ(SEQUENCEOF)</td>
</tr>
<tr class="row-even"><td rowspan="3">アプリケーションワイド型
(特別な値)</td>
<td>32ビット整数(INTEGER32)</td>
</tr>
<tr class="row-odd"><td>IPアドレス(IPAddress)</td>
</tr>
<tr class="row-even"><td>時間(TimeTicks)</td>
</tr>
</tbody>
</table>
<p>管理オブジェクトの定義はマクロと呼ばれ、アクセス制限などを定義します。</p>
</div>
<div class="section" id="mib-management-informantion-base">
<h3>MIB(Management Informantion Base)<a class="headerlink" href="#mib-management-informantion-base" title="Permalink to this headline">¶</a></h3>
<p>MIBとは、管理オブジェクトをまとめて1つのデータベースとしたものです。MIBはオブジェクトID(OID)を使用した木構造で、管理オブジェクトを管理しています。これをMIBツリーといいます。</p>
<p>SNMPではiso(1).org(3).dod(6).internnet(1)から下のOIDを使用します。これは、OIDが、SNMP以外でも使用されるためです。</p>
<ul class="simple">
<li>net-snmpのOID一覧<ul>
<li><a class="reference external" href="http://park1.wakwak.com/~ima/freebsd_netsnmpoidlist.html">http://park1.wakwak.com/~ima/freebsd_netsnmpoidlist.html</a></li>
</ul>
</li>
</ul>
</div>
</div>
<div class="section" id="id5">
<h2>SNMPのバージョン<a class="headerlink" href="#id5" title="Permalink to this headline">¶</a></h2>
<div class="section" id="snmpv1-v2c">
<h3>SNMPv1 と v2c<a class="headerlink" href="#snmpv1-v2c" title="Permalink to this headline">¶</a></h3>
<p>SNMPで管理 <strong>する側</strong> のSNMPソフトウェアを <em>マネージャ</em> 、管理 <strong>される側</strong> のSNMPソフトウェアを <em>エージェント</em> といいます。</p>
<p>SNMPパケットには <strong>UDP</strong> を使用します。通知には <em>162番</em> 、要求と設定には <em>161番</em> を使用します。</p>
<p>SNMPでは同じコミュニティが設定してあるエージェントとマネージャ同士のみやりとりができます。また複数の同じノードで複数のコミュニティを設定することもできます。SNMPv1,v2cでは平文でコミュニティ名を送信するため、セキュリティに問題があります。</p>
<div class="highlight-python"><pre>* 通知
+-----------+------------------------------+--------------+
|           | UDP Header                   |              |
| IP Header +-------------+----------------+ SNMP Message |
|           | Source-port | Dest-port(162) |              |
+-----------+------------------------------+--------------+

* 要求、設定
+-----------+------------------------------+--------------+
|           | UDP Header                   |              |
| IP Header +-------------+----------------+ SNMP Message |
|           | Source-port | Dest-port(161) |              |
+-----------+------------------------------+--------------+</pre>
</div>
<div class="section" id="id6">
<h4>SNMPメッセージ<a class="headerlink" href="#id6" title="Permalink to this headline">¶</a></h4>
<p>SNMPメッセージの構造は、SNMPバージョン、コミュニティ名、PDU(後述)から構成されます。</p>
<div class="highlight-python"><pre>SNMPメッセージの構造
+---------------+-----------+-------+
| SNMP Version  | Community | PDU   |
+---------------+-----------+-------+</pre>
</div>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Version:</th><td class="field-body">SNMPのバージョン。v1(0)、v2c(1)。</td>
</tr>
<tr class="field-even field"><th class="field-name">Community:</th><td class="field-body">コミュニティ名</td>
</tr>
<tr class="field-odd field"><th class="field-name">PDU:</th><td class="field-body">SNMPデータ</td>
</tr>
</tbody>
</table>
<p>SNMPv1,v2cでのPDUの種類は以下の通りです。</p>
<table border="1" class="docutils">
<colgroup>
<col width="15%" />
<col width="24%" />
<col width="15%" />
<col width="47%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">PDU-type</th>
<th class="head">PDU名</th>
<th class="head">Version</th>
<th class="head">概要</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td>0</td>
<td>GetRequest</td>
<td>v1,v2c</td>
<td>マネージャからの情報取得要求
指定したインスタンスを取得</td>
</tr>
<tr class="row-odd"><td>1</td>
<td>GetNextRequest</td>
<td>v1,v2c</td>
<td>マネージャからの情報取得要求
指定した次のインスタンスを取得</td>
</tr>
<tr class="row-even"><td>2</td>
<td>GetResponse</td>
<td>v1</td>
<td>マネージャからの要求に対する応答</td>
</tr>
<tr class="row-odd"><td>3</td>
<td>SetRequiest</td>
<td>v1,v2c</td>
<td>マネージャからの設定要求</td>
</tr>
<tr class="row-even"><td>4(v1),
7(v2)</td>
<td>Trap</td>
<td>v1,v2c</td>
<td>エージェントからの通知</td>
</tr>
<tr class="row-odd"><td>2</td>
<td>Response</td>
<td>v2c</td>
<td>マネージャからの要求に対する応答
GetResponseの置き換え</td>
</tr>
<tr class="row-even"><td>5</td>
<td>GetBulkRequest</td>
<td>v2c</td>
<td>マネージャからの情報取得要求
指定した範囲のインスタンスを取得</td>
</tr>
<tr class="row-odd"><td>6</td>
<td>InformRequest</td>
<td>v2c</td>
<td>エージェントからの通知
マネージャが応答対応を返す</td>
</tr>
</tbody>
</table>
<p>インスタンスと表記しているのは、NICのように同じオブジェクトIDで複数のインスタンスを持ち得るからです。</p>
</div>
<div class="section" id="id7">
<h4>要求、設定<a class="headerlink" href="#id7" title="Permalink to this headline">¶</a></h4>
<p>GetRequest, GetNextRequest, GetResponse, SetRequestには下記のPDUを使用します。</p>
<div class="highlight-python"><pre>+------+----------+--------+--------+---------------------------------+
|      |          |        |        | variable-bindings               |
|      |          |        |        +-------------+-------------+-----+
| PDU- | request- | error- | error- | variable-   | variable-   | ... |
| type | id       | status | index  | bindings1   | bindings2   |     |
|      |          |        |        +-----+-------+-----+-------+-----+
|      |          |        |        | oid | value | oid | value | ... |
+------+----------+--------+--------+-----+-------+-----+-------+-----+</pre>
</div>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">PDU-type:</th><td class="field-body">PDUタイプ</td>
</tr>
<tr class="field-even field"><th class="field-name">request-id:</th><td class="field-body">マネージャからの要求を区別するための番号。応答の場合、同じIDが入る</td>
</tr>
<tr class="field-odd field"><th class="field-name">error-status:</th><td class="field-body">エラー識別子。応答以外の場合0が入る</td>
</tr>
<tr class="field-even field"><th class="field-name">error-index:</th><td class="field-body">エラーが発生したvariable-bindingsの番号</td>
</tr>
<tr class="field-odd field"><th class="field-name" colspan="2">variable-bindings1-n:</th></tr>
<tr class="field-odd field"><td>&nbsp;</td><td class="field-body">要求、設定する管理オブジェクトのインスタンス。複数格納可能。要求の場合値にnullを入れる</td>
</tr>
</tbody>
</table>
<p>error-statusの値は以下の通りです。</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">noError(0):</th><td class="field-body">エラー無し</td>
</tr>
<tr class="field-even field"><th class="field-name">tooBig(1):</th><td class="field-body">応答メッセージのサイズが大きすぎる</td>
</tr>
<tr class="field-odd field"><th class="field-name">noSuchName(2):</th><td class="field-body">指定したOIDが存在しない</td>
</tr>
<tr class="field-even field"><th class="field-name">badValue(3):</th><td class="field-body">異常な管理オブジェクトの値を指定した</td>
</tr>
<tr class="field-odd field"><th class="field-name">readOnly(4):</th><td class="field-body">通常は未使用</td>
</tr>
<tr class="field-even field"><th class="field-name">genErr(5):</th><td class="field-body">上記以外のエラー</td>
</tr>
</tbody>
</table>
</div>
<div class="section" id="getrequest-getnextrequest">
<h4>GetRequest, GetNextRequest<a class="headerlink" href="#getrequest-getnextrequest" title="Permalink to this headline">¶</a></h4>
<p>GetRequestは複数の値を取得することができます。GetNextRequestは指定した次のインスタンスを取得します。OIDは抜けなく並んでいるわけではないので、次の値を取得する場合に通常GetNextRequestを使用します。</p>
</div>
<div class="section" id="id8">
<h4>SNMPv1, v2cのエラー処理の違い<a class="headerlink" href="#id8" title="Permalink to this headline">¶</a></h4>
<p>v1ではGetRequest, GetNextRequest, SetRequestに複数のインスタンスを指定したいた場合、そのうち一つでもエラーが発生するとすべてエラーとして応答されます。そのため、大量の情報のやりとりがしずらい使用となっています。</p>
<p>v2cではその点が改善され、インスタンスごとにエラーを通知できるようになっています。また、GetBulkRequest使用することにより範囲指定でインスタンスが取得できるようになり、大量の情報をやりとりしやすくなっています。</p>
</div>
<div class="section" id="trap">
<h4>Trap<a class="headerlink" href="#trap" title="Permalink to this headline">¶</a></h4>
<p>Trap-PDUの内容以下の通りです。</p>
<div class="highlight-python"><pre>+------+------------+--------+----------+-----------+-----------+---------------------------------+
|      |            |        |          |           |           | variable-bindings               |
|      |            |        |          |           |           +-------------+-------------+-----+
| PDU- | enterprise | agent- | generic- | specific- | timestamp | variable-   | variable-   | ... |
| type |            | addr   | trap     | trap      |           | bindings1   | bindings2   |     |
|      |            |        |          |           |           +-----+-------+-----+-------+-----+
|      |            |        |          |           |           | oid | value | oid | value | ... |
+------+------------+--------+----------+-----------+-----------+-----+-------+-----+-------+-----+</pre>
</div>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">PDU-type:</th><td class="field-body">PDUタイプ。(4)</td>
</tr>
<tr class="field-even field"><th class="field-name">enterprise:</th><td class="field-body">エージェントの識別子</td>
</tr>
<tr class="field-odd field"><th class="field-name">agent-addr:</th><td class="field-body">エージェントのIPアドレス</td>
</tr>
<tr class="field-even field"><th class="field-name">generic-trap:</th><td class="field-body">トラップの種別</td>
</tr>
<tr class="field-odd field"><th class="field-name">specific-trap:</th><td class="field-body">企業トラップの場合使用する。標準のトラップの場合0。</td>
</tr>
<tr class="field-even field"><th class="field-name">timestamp:</th><td class="field-body">エージェントが初期化されてからの時間</td>
</tr>
<tr class="field-odd field"><th class="field-name" colspan="2">variable-bindings1-n:</th></tr>
<tr class="field-odd field"><td>&nbsp;</td><td class="field-body">通知する管理オブジェクトのインスタンス。複数格納可能</td>
</tr>
</tbody>
</table>
<p>トラップの種類は以下の通りです。</p>
<table border="1" class="docutils">
<colgroup>
<col width="31%" />
<col width="31%" />
<col width="38%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">&nbsp;</th>
<th class="head">generic-trapの値</th>
<th class="head">種別</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td rowspan="6">標準トラップ</td>
<td>0</td>
<td>coldStart</td>
</tr>
<tr class="row-odd"><td>1</td>
<td>warmStart</td>
</tr>
<tr class="row-even"><td>2</td>
<td>linkdown</td>
</tr>
<tr class="row-odd"><td>3</td>
<td>linkup</td>
</tr>
<tr class="row-even"><td>4</td>
<td>authenticationFailure</td>
</tr>
<tr class="row-odd"><td>5</td>
<td>egpNeighborLoss</td>
</tr>
<tr class="row-even"><td>企業固有トラップ</td>
<td>6</td>
<td>enterpriseSpecific</td>
</tr>
</tbody>
</table>
<p>っね、シンプルでしょ。。。</p>
</div>
</div>
<div class="section" id="snmpv3">
<h3>SNMPv3<a class="headerlink" href="#snmpv3" title="Permalink to this headline">¶</a></h3>
<ul class="simple">
<li>割愛</li>
</ul>
</div>
</div>
<div class="section" id="net-snmp">
<h2>Net-SNMP<a class="headerlink" href="#net-snmp" title="Permalink to this headline">¶</a></h2>
<p>Debianの標準のsnmpクライアント/サーバはnet-snmpです。古くはucd-snmpと呼ばれていました。</p>
<ul class="simple">
<li><a class="reference external" href="http://www.net-snmp.org/">http://www.net-snmp.org/</a></li>
</ul>
<div class="section" id="id9">
<h3>インストール<a class="headerlink" href="#id9" title="Permalink to this headline">¶</a></h3>
<div class="highlight-python"><pre>sudo aptitude insntall snmpd # サーバ
sudo aptitude insntall snmp  # クライアント</pre>
</div>
</div>
<div class="section" id="snmpd">
<h3>snmpdの設定<a class="headerlink" href="#snmpd" title="Permalink to this headline">¶</a></h3>
<p>/etc/snmp/snmpd.confの設定</p>
<div class="highlight-none"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20</pre></div></td><td class="code"><div class="highlight"><pre>#       sec.name  source          community
com2sec local     localhost       private
com2sec mynetwork 192.168.1.0/24  public

#             &gt;-sec.model  sec.name
group MyGroup v1         local
group MyGroup v2c        local
group MyGroup usm        local
group MyGroup v1         mynetwork
group MyGroup v2c        mynetwork
group MyGroup usm        mynetwork

#           incl/excl subtree                          mask
view all    included  .1                               80

#                context sec.model sec.level match  read   write  notif
access MyGroup   &quot;&quot;      any       noauth    exact  all    all    all

syslocation intra
syscontact Root &lt;root@localhost&gt;
</pre></div>
</td></tr></table></div>
<p>/etc/default/snmpdの設定</p>
<div class="highlight-none"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24</pre></div></td><td class="code"><div class="highlight"><pre># This file controls the activity of snmpd and snmptrapd

# MIB directories.  /usr/share/snmp/mibs is the default, but
# including it here avoids some strange problems.
export MIBDIRS=/usr/share/snmp/mibs

# snmpd control (yes means start daemon).
SNMPDRUN=yes

# snmpd options (use syslog, close stdin/out/err).
#SNMPDOPTS=&#39;-Lsd -Lf /dev/null -u snmp -I -smux -p /var/run/snmpd.pid 127.0.0.1&#39; 外部からsnmpを受け付ける
SNMPDOPTS=&#39;-Lsd -Lf /dev/null -u snmp -I -smux -p /var/run/snmpd.pid&#39;

# snmptrapd control (yes means start daemon).  As of net-snmp version
# 5.0, master agentx support must be enabled in snmpd before snmptrapd
# can be run.  See snmpd.conf(5) for how to do this.
#TRAPDRUN=no
TRAPDRUN=yes

# snmptrapd options (use syslog).
TRAPDOPTS=&#39;-Lsd -p /var/run/snmptrapd.pid&#39;

# create symlink on Debian legacy location to official RFC path
SNMPDCOMPAT=yes
</pre></div>
</td></tr></table></div>
<ul class="simple">
<li>参考:snmpd.conf<ul>
<li><a class="reference external" href="http://archive.linux.or.jp/JM/html/ucd-snmp/man5/snmpd.conf.5.html">http://archive.linux.or.jp/JM/html/ucd-snmp/man5/snmpd.conf.5.html</a></li>
</ul>
</li>
</ul>
</div>
<div class="section" id="id10">
<h3>snmpコマンドで情報を取得してみる<a class="headerlink" href="#id10" title="Permalink to this headline">¶</a></h3>
<p>OID直打ちでも、OIDのエイリアスでもOKです。snmpwalkはget-next-requestとget-bulk-requestを駆使して指定OID以下をごそっと取ってくる便利なコマンドです。</p>
<p>-Oコマンドで出力形式を変更することができます。nで数値形式、fで省略なしのOID名が出力されます。</p>
<div class="highlight-python"><pre>[ LAB ] masasuzu@masalab01% snmpwalk -v 2c -c private localhost .1.3.6.1.2.1.1.1
SNMPv2-MIB::sysDescr.0 = STRING: Linux masalab01 2.6.30-1-686 #1 SMP Sun Jun 14 16:11:32 UTC 2009 i686

[ LAB ] masasuzu@masalab01% snmpwalk -v 2c -c private -Of localhost system.sysDescr
.iso.org.dod.internet.mgmt.mib-2.system.sysDescr.0 = STRING: Linux masalab01 2.6.30-1-686 #1 SMP Sun Jun 14 16:11:32 UTC 2009 i686

[ LAB ] masasuzu@masalab01% snmpwalk -v 2c -c private -On localhost system.sysDescr
.1.3.6.1.2.1.1.1.0 = STRING: Linux masalab01 2.6.30-1-686 #1 SMP Sun Jun 14 16:11:32 UTC 2009 i686</pre>
</div>
</div>
<div class="section" id="snmptrapd">
<h3>snmptrapdの設定<a class="headerlink" href="#snmptrapd" title="Permalink to this headline">¶</a></h3>
<p>/etc/snmp/snmptrapd.confの設定</p>
<div class="highlight-python"><pre># 受け付けるコミュニティの設定
authCommunity log,execute,net public</pre>
</div>
<p>/etc/default/snmpdの設定</p>
<div class="highlight-python"><div class="highlight"><pre><span class="c"># snmpd起動時にsnmptrapdを起動する</span>
<span class="c">#TRAPDRUN=no</span>
<span class="n">TRAPDRUN</span><span class="o">=</span><span class="n">yes</span>
</pre></div>
</div>
</div>
<div class="section" id="snmptrap">
<h3>snmptrapを受信してみる<a class="headerlink" href="#snmptrap" title="Permalink to this headline">¶</a></h3>
<p>snmptrapコマンドでtrapを送信することができます。snmptrapdが受信したトラップはsyslogに記録されます。</p>
<div class="highlight-python"><pre># トラップ送信
[ LAB ] masasuzu@masalab01% snmptrap -v 2c -c public masalab01.intra '' .1.3.6.1.4.1.311.1.1.3.1.2 .1.3.6.1.4.1.311.1.1.3.1.2 s "Test Trap"

# lv /var/log/syslog
Apr  6 09:52:19 masalab01 snmptrapd[19185]: 2011-04-06 09:52:19 172.16.201.118 [UDP: [172.16.201.118]:32972]:#012DISMAN-EVENT-MIB::sysUpTimeInstance = Timeticks: (768473162) 88 days, 22:38:51.62#011SNMPv2-MIB::snmpTrapOID.0 = OID: SNMPv2-SMI::enterprises.311.1.1.3.1.2#011SNMPv2-SMI::enterprises.311.1.1.3.1.2 = STRING: "Test Trap"</pre>
</div>
</div>
</div>
<div class="section" id="perlsnmp">
<h2>PerlからSNMPをいじってみる<a class="headerlink" href="#perlsnmp" title="Permalink to this headline">¶</a></h2>
<p>Net::SNMPを使うのが一般的です。</p>
<ul class="simple">
<li><a class="reference external" href="http://search.cpan.org/~dtown/Net-SNMP-v6.0.1/lib/Net/SNMP.pm">http://search.cpan.org/~dtown/Net-SNMP-v6.0.1/lib/Net/SNMP.pm</a></li>
</ul>
<p>App::MadEye::Util::snmp_session()やApp::MadEye::Plugin::Agent::SNMP::* あたりで使用されてます。</p>
<ul class="simple">
<li><a class="reference external" href="http://search.cpan.org/~tokuhirom/App-MadEye-0.07/lib/App/MadEye.pm">http://search.cpan.org/~tokuhirom/App-MadEye-0.07/lib/App/MadEye.pm</a></li>
</ul>
<p>でも、CloudforecastではSNMPを使っています。</p>
<ul class="simple">
<li><a class="reference external" href="https://github.com/kazeburo/cloudforecast">https://github.com/kazeburo/cloudforecast</a></li>
</ul>
<div class="section" id="id11">
<h3>サンプルコード<a class="headerlink" href="#id11" title="Permalink to this headline">¶</a></h3>
<div class="highlight-perl"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32</pre></div></td><td class="code"><div class="highlight"><pre><span class="k">use</span> <span class="n">strict</span><span class="p">;</span>
<span class="k">use</span> <span class="n">warnings</span><span class="p">;</span>

<span class="k">use</span> <span class="nn">Net::</span><span class="n">SNMP</span><span class="p">;</span>

<span class="c1"># ipAdEntAddr =&gt; &#39;.1.3.6.1.2.1.4.20.1.1&#39;</span>
<span class="k">my</span> <span class="nv">$OID</span> <span class="o">=</span> <span class="s">&#39;.1.3.6.1.2.1.4.20.1.1&#39;</span><span class="p">;</span>

<span class="k">my</span> <span class="p">(</span><span class="nv">$session</span><span class="p">,</span> <span class="nv">$error</span><span class="p">)</span> <span class="o">=</span> <span class="nn">Net::</span><span class="n">SNMP</span><span class="o">-&gt;</span><span class="n">session</span><span class="p">(</span>
    <span class="o">-</span><span class="n">hostname</span>  <span class="o">=&gt;</span> <span class="s">&#39;localhost&#39;</span><span class="p">,</span>
    <span class="o">-</span><span class="n">community</span> <span class="o">=&gt;</span> <span class="s">&#39;private&#39;</span><span class="p">,</span>
    <span class="o">-</span><span class="n">port</span>      <span class="o">=&gt;</span> <span class="mi">161</span><span class="p">,</span>
    <span class="o">-</span><span class="n">timeout</span>   <span class="o">=&gt;</span> <span class="mi">10</span><span class="p">,</span>
    <span class="o">-</span><span class="n">retries</span>   <span class="o">=&gt;</span> <span class="mi">1</span><span class="p">,</span>
<span class="p">);</span>

<span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="nb">defined</span><span class="p">(</span><span class="nv">$session</span><span class="p">))</span> <span class="p">{</span>
    <span class="nb">die</span> <span class="s">&quot;ERROR: $error.\n&quot;</span><span class="p">;</span>
<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="c1"># SEE http://search.cpan.org/~dtown/Net-SNMP-v6.0.1/lib/Net/SNMP.pm#get_table()_-_retrieve_a_table_from_the_remote_agent</span>
    <span class="c1"># get-next-requestとget-bulk-requestを駆使して、baseoid以下のオブジェクトをごっそり持ってくる</span>
    <span class="k">my</span> <span class="nv">$response</span> <span class="o">=</span> <span class="nv">$session</span><span class="o">-&gt;</span><span class="n">get_table</span><span class="p">(</span><span class="o">-</span><span class="n">baseoid</span> <span class="o">=&gt;</span> <span class="nv">$OID</span><span class="p">)</span>
         <span class="ow">or</span> <span class="nb">die</span> <span class="s">&quot;cannot get snmp response. &quot;</span> <span class="o">.</span> <span class="nv">$session</span><span class="o">-&gt;</span><span class="n">error</span><span class="p">;</span>
    <span class="nv">$session</span><span class="o">-&gt;</span><span class="nb">close</span><span class="p">();</span>

    <span class="k">use</span> <span class="n">YAML</span><span class="p">;</span>
    <span class="k">print</span> <span class="nn">YAML::</span><span class="n">Dump</span><span class="p">(</span><span class="nv">$response</span><span class="p">);</span>
<span class="p">}</span>
<span class="c1">#出力はこんな感じ</span>
<span class="c1">#---</span>
<span class="c1">#.1.3.6.1.2.1.4.20.1.1.127.0.0.1: 127.0.0.1</span>
<span class="c1">#.1.3.6.1.2.1.4.20.1.1.172.16.250.144: 172.16.250.144</span>
</pre></div>
</td></tr></table></div>
</div>
</div>
<div class="section" id="id12">
<h2>参考文献<a class="headerlink" href="#id12" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li><a class="reference external" href="http://www.itmedia.co.jp/enterprise/special/0705/snmp/">SNMPによるネットワークモニタリング</a>.</li>
</ul>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
  <h3><a href="../index.html">Table Of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">SNMP - Simple Network Management Protocol</a><ul>
<li><a class="reference internal" href="#agenda">Agenda</a></li>
<li><a class="reference internal" href="#id1">監視について</a></li>
<li><a class="reference internal" href="#snmp">SNMPの概要</a><ul>
<li><a class="reference internal" href="#id2">SNMPの機能</a></li>
<li><a class="reference internal" href="#id3">SNMP管理フレームワーク</a></li>
<li><a class="reference internal" href="#id4">SNMP管理フレームワークのバージョン</a></li>
</ul>
</li>
<li><a class="reference internal" href="#smimib">SMIとMIB</a><ul>
<li><a class="reference internal" href="#smi-struscture-of-manangement-information">SMI(Struscture of Manangement Information)</a></li>
<li><a class="reference internal" href="#mib-management-informantion-base">MIB(Management Informantion Base)</a></li>
</ul>
</li>
<li><a class="reference internal" href="#id5">SNMPのバージョン</a><ul>
<li><a class="reference internal" href="#snmpv1-v2c">SNMPv1 と v2c</a><ul>
<li><a class="reference internal" href="#id6">SNMPメッセージ</a></li>
<li><a class="reference internal" href="#id7">要求、設定</a></li>
<li><a class="reference internal" href="#getrequest-getnextrequest">GetRequest, GetNextRequest</a></li>
<li><a class="reference internal" href="#id8">SNMPv1, v2cのエラー処理の違い</a></li>
<li><a class="reference internal" href="#trap">Trap</a></li>
</ul>
</li>
<li><a class="reference internal" href="#snmpv3">SNMPv3</a></li>
</ul>
</li>
<li><a class="reference internal" href="#net-snmp">Net-SNMP</a><ul>
<li><a class="reference internal" href="#id9">インストール</a></li>
<li><a class="reference internal" href="#snmpd">snmpdの設定</a></li>
<li><a class="reference internal" href="#id10">snmpコマンドで情報を取得してみる</a></li>
<li><a class="reference internal" href="#snmptrapd">snmptrapdの設定</a></li>
<li><a class="reference internal" href="#snmptrap">snmptrapを受信してみる</a></li>
</ul>
</li>
<li><a class="reference internal" href="#perlsnmp">PerlからSNMPをいじってみる</a><ul>
<li><a class="reference internal" href="#id11">サンプルコード</a></li>
</ul>
</li>
<li><a class="reference internal" href="#id12">参考文献</a></li>
</ul>
</li>
</ul>

  <h4>Previous topic</h4>
  <p class="topless"><a href="acl.html"
                        title="previous chapter">ACL Access Control List</a></p>
  <h3>This Page</h3>
  <ul class="this-page-menu">
    <li><a href="../_sources/network/snmp.txt"
           rel="nofollow">Show Source</a></li>
  </ul>
<div id="searchbox" style="display: none">
  <h3>Quick search</h3>
    <form class="search" action="../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="acl.html" title="ACL Access Control List"
             >previous</a> |</li>
        <li><a href="../index.html">masasuzu docs 1.0 documentation</a> &raquo;</li>
          <li><a href="index.html" >ネットワークに関する雑多な記事</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer">
        &copy; Copyright 2012, masasuzu / SUZUKI Masashi.
      Created using <a href="http://sphinx.pocoo.org/">Sphinx</a> 1.1.2.
    </div>
  </body>
</html>